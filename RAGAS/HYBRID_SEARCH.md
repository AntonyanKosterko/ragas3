# üîç –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –≤ RAG —Å–∏—Å—Ç–µ–º–µ

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç **—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫** –∏ **–∫–ª—é—á–µ–≤–æ–π –ø–æ–∏—Å–∫ (BM25)** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤, –≥–¥–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –≤–∞–∂–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### 1. **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Å–º—ã—Å–ª—É
- –•–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ –∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ù–∞—Ö–æ–¥–∏—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

### 2. **BM25 –ø–æ–∏—Å–∫**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ç–µ—Ä–º–∏–Ω–æ–≤
- –£—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –¥–ª–∏–Ω—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### 3. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
- –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –≤–µ—Å–∞–º–∏
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å–∫–æ—Ä—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–∫–æ—Ä—É

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```yaml
hybrid_search:
  # –í–µ—Å–∞ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ–ª–∂–Ω—ã —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ 1.0)
  semantic_weight: 0.7  # –í–µ—Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
  bm25_weight: 0.3      # –í–µ—Å BM25 –ø–æ–∏—Å–∫–∞
  
  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  semantic_k: 10        # –î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
  bm25_k: 10           # –î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ç BM25 –ø–æ–∏—Å–∫–∞
  final_k: 5           # –§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  
  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  rerank: true         # –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  normalize_scores: true  # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ–≤
  
  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã BM25
  bm25_k1: 1.2         # –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–≤
  bm25_b: 0.75         # –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –≤–ª–∏—è–Ω–∏–µ –¥–ª–∏–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã BM25:

- **k1 (1.2)**: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç —Å–∫–æ—Ä —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —á–∞—Å—Ç–æ—Ç—ã —Ç–µ—Ä–º–∏–Ω–∞
  - –ú–µ–Ω—å—à–µ k1 ‚Üí –º–µ–Ω—å—à–µ –≤–ª–∏—è–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
  - –ë–æ–ª—å—à–µ k1 ‚Üí –±–æ–ª—å—à–µ –≤–ª–∏—è–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
  
- **b (0.75)**: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –≤–ª–∏—è–Ω–∏–µ –¥–ª–∏–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞
  - b=0 ‚Üí –¥–ª–∏–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –≤–ª–∏—è–µ—Ç
  - b=1 ‚Üí –ø–æ–ª–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –¥–ª–∏–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
```bash
pip install rank-bm25
```

### 2. **–ó–∞–ø—É—Å–∫ —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º**
```bash
# CPU –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
python test_rag.py --config config/hybrid_cpu_config.yaml --max-samples 100

# GPU –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
python test_rag.py --config config/hybrid_gpu_config.yaml --max-samples 100

# –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
python app.py --config config/hybrid_cpu_config.yaml --interface gradio
```

### 3. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–±—ã—á–Ω—ã–º –ø–æ–∏—Å–∫–æ–º**
```bash
# –û–±—ã—á–Ω—ã–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
python test_rag.py --config config/cpu_optimized_config.yaml --max-samples 100

# –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
python test_rag.py --config config/hybrid_cpu_config.yaml --max-samples 100
```

## üìä –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–µ—Å–æ–≤**
```yaml
# –¢–µ—Å—Ç 1: –ë–æ–ª—å—à–µ —Å–µ–º–∞–Ω—Ç–∏–∫–∏
semantic_weight: 0.8
bm25_weight: 0.2

# –¢–µ—Å—Ç 2: –ë–æ–ª—å—à–µ BM25
semantic_weight: 0.5
bm25_weight: 0.5

# –¢–µ—Å—Ç 3: –†–∞–≤–Ω—ã–µ –≤–µ—Å–∞
semantic_weight: 0.5
bm25_weight: 0.5
```

### **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 2: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**
```yaml
# –¢–µ—Å—Ç 1: –ú–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
semantic_k: 5
bm25_k: 5
final_k: 3

# –¢–µ—Å—Ç 2: –ú–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
semantic_k: 20
bm25_k: 20
final_k: 10
```

### **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 3: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã BM25**
```yaml
# –¢–µ—Å—Ç 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
bm25_k1: 1.2
bm25_b: 0.75

# –¢–µ—Å—Ç 2: –ë–æ–ª—å—à–µ –≤–ª–∏—è–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
bm25_k1: 2.0
bm25_b: 0.75

# –¢–µ—Å—Ç 3: –ë–æ–ª—å—à–µ –≤–ª–∏—è–Ω–∏–µ –¥–ª–∏–Ω—ã
bm25_k1: 1.2
bm25_b: 1.0
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### **–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞:**
- **Precision@K**: +10-20% —É–ª—É—á—à–µ–Ω–∏–µ
- **Recall@K**: +5-15% —É–ª—É—á—à–µ–Ω–∏–µ
- **MRR**: +15-25% —É–ª—É—á—à–µ–Ω–∏–µ
- **NDCG@K**: +10-20% —É–ª—É—á—à–µ–Ω–∏–µ

### **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞:**
- –õ—É—á—à–µ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å —Ç–æ—á–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—é —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:**
```python
combined_score = (
    semantic_weight * semantic_score +
    bm25_weight * bm25_score
)
```

### **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ–≤:**
```python
# Min-max –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
normalized_score = (score - min_score) / (max_score - min_score)
```

### **Fallback –º–µ—Ö–∞–Ω–∏–∑–º:**
- –ü—Ä–∏ –æ—à–∏–±–∫–µ BM25 ‚Üí —Ç–æ–ª—å–∫–æ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ ‚Üí —Ç–æ–ª—å–∫–æ BM25
- –ü—Ä–∏ –ø–æ–ª–Ω–æ–π –æ—à–∏–±–∫–µ ‚Üí –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

### **–î–ª—è CPU:**
- `semantic_weight: 0.7, bm25_weight: 0.3`
- `semantic_k: 10, bm25_k: 10, final_k: 5`
- `bm25_k1: 1.2, bm25_b: 0.75`

### **–î–ª—è GPU:**
- `semantic_weight: 0.8, bm25_weight: 0.2`
- `semantic_k: 15, bm25_k: 15, final_k: 5`
- `bm25_k1: 1.2, bm25_b: 0.75`

### **–î–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤:**
- –ù–∞—á–Ω–∏—Ç–µ —Å —Ä–∞–≤–Ω—ã—Ö –≤–µ—Å–æ–≤ (0.5/0.5)
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –ª–æ–≥–∏—Ä—É–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
- –û—à–∏–±–∫–∏ –∏ fallback —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å–∫–æ—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üö® –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ
2. **–ü–∞–º—è—Ç—å**: –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –¥–ª—è BM25 –∏–Ω–¥–µ–∫—Å–∞
3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –¢—Ä–µ–±—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `rank-bm25`
4. **–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è**: –ü—Ä–æ—Å—Ç–∞—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–µ—Å–∞**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Å–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø—Ä–æ—Å–∞
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ BM25 –∏–Ω–¥–µ–∫—Å–∞
4. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ BM25 –ø–æ–∏—Å–∫–∞
